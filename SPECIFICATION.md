# 旅行プランニングエージェント�細仕様書

## 1. 概要
このドキュメントは、AIを活用した旅行プランニングエージェントの実装仕様を詳細に定義します。本システムは、ユーザーの入力に基づいて最適な旅行プランを自動生成し、予算最適化を行うことができます。

## 2. システム構成

### 2.1 主要コンポーネント
- `src/index.ts`: メインエントリーポイント
  - アプリケーションの起動
  - ユーザー入力の処理
  - 進行状況の表示
  - 出力フォーマットの整形
  - エラーハンドリング

- `src/graph.ts`: 旅行プラン生成ロジック
  - プロンプトテンプレートの定義
  - OpenAI APIとの通信
  - プラン生成ロジックの実装
  - 予算最適化の処理

### 2.2 依存関係
- @langchain/openai: ^0.0.1
  - OpenAI APIとの通信
  - チャットモデルの利用
- @langchain/core: ^0.1.0
  - プロンプトテンプレート
  - シーケンス処理
- dotenv: ^16.0.0
  - 環境変数の管理
  - APIキーの安全な取り扱い

## 3. 機能仕様

### 3.1 基本機能
1. 旅行プラン生成
   - 入力パラメータ
     - 出発地（必須）: 文字列
     - 目的地（必須）: 文字列
     - 旅行日数（必須）: 数値（1以上）
     - 予算（オプション）: 数値（円）
   - バリデーション
     - 必須項目のチェック
     - 数値の範囲チェック
     - 不正な入力値の処理

2. 進行状況表示
   - 表示仕様
     - 初期メッセージ: "旅行プランを考え中"
     - 進捗表示: 1秒間隔でドット(.)を追加
     - 改行処理: 50ドットごとに改行
     - 終了時: 2行の改行を挿入
   - 制御機能
     - 開始・停止の制御
     - インターバルのクリア処理
     - エラー時の表示停止

3. 出力フォーマット整形
   - テキスト処理
     - セクション間: 空行の追加
     - テーブル整形: ヘッダー区切り線の挿入
     - 日程区分: 各日の間に空行を追加
   - 正規表現パターン
     - セクション検出: /^#/gm
     - テーブルヘッダー検出: /\|\s*日付\s*\|\s*時間\s*\|\s*行動\s*\|\s*詳細\s*\|\s*移動手段\s*\|/
     - 日程区分検出: /(\|\s*\d+日目.*\n)(?=\|\s*\d+日目)/g

### 3.2 プラン生成仕様

#### 3.2.1 基本プラン
1. 概要セクション
   - 移動手段
     - 主要交通手段の指定
     - 所要時間の目安
     - 推奨ルートの提案
   - 宿泊先エリア
     - 地域の特徴
     - アクセス便利度
     - 観光地との位置関係
   - 予算目安
     - 総額の目安
     - 項目別の概算
     - 予備費の推奨額
   - 持ち物アドバイス
     - 必須アイテム
     - 季節に応じた持ち物
     - 現地調達可能なもの

2. 詳細日程
   - 各日5つの固定時間帯の予定（必須）
     1. 朝の予定（07:00-09:00）
        - 起床時刻
        - 朝食内容
        - 準備時間
        - 初日特別対応（出発準備）
        - 最終日特別対応（帰国準備）
     2. 午前の予定（09:00-12:00）
        - メインアクティビティ
        - 所要時間
        - 予約の要否
        - 天候考慮事項
     3. 昼食の予定（12:00-14:00）
        - 飲食店情報
        - 予算目安
        - 所要時間
        - 予約の要否
     4. 午後の予定（14:00-18:00）
        - メインアクティビティ
        - 代替案
        - 休憩ポイント
        - 写真スポット
     5. 夜の予定（18:00-22:00）
        - 夕食プラン
        - ナイトライフ
        - 帰着時刻
        - 翌日の準備
   
   - 各予定の詳細情報
     - 時間（24時間表記）
       - 開始時刻
       - 終了時刻
       - 所要時間
     - 行動内容
       - アクティビティ名
       - 具体的な内容
       - 予約要否
     - 詳細説明
       - 場所の説明
       - 注意事項
       - 代替案
     - 移動手段
       - 交通手段
       - 所要時間
       - 概算費用

3. 補足情報
   - おすすめグルメスポット
     - 店舗名
     - 料理の種類
     - 価格帯
     - 予約要否
   - 気候や服装のアドバイス
     - 季節別の気温
     - 降水確率
     - 推奨服装
     - 必要な装備
   - 現地での注意点
     - 治安情報
     - 文化的配慮
     - 緊急連絡先
     - 医療機関情報

#### 3.2.2 予算最適化プラン
1. 予算内訳
   - 交通費
     - 航空券
       - 往復料金
       - 手数料
       - 季節変動
     - 現地交通費
       - 公共交通機関
       - タクシー
       - レンタカー
   - 宿泊費
     - ホテルグレード
       - スター評価
       - 設備内容
       - 立地条件
     - 宿泊エリア
       - アクセス便利度
       - 周辺環境
       - 治安状況
   - 食費
     - 朝食
       - ホテル朝食
       - 外食
       - 軽食
     - 昼食
       - レストラン
       - カフェ
       - フードコート
     - 夕食
       - 高級店
       - カジュアル店
       - 屋台
   - アクティビティ費用
     - 観光スポット入場料
       - 主要スポット
       - オプション
       - 割引情報
     - オプショナルツアー
       - ガイド付きツアー
       - 体験プログラム
       - 特別イベント
   - その他経費
     - お土産
       - 食品
       - 雑貨
       - 特産品
     - 予備費
       - 緊急時対応
       - 追加アクティビティ
       - 予期せぬ出費

2. 最適化提案
   - 予算に応じた具体的な提案
     - 予算超過項目の特定
     - 代替案の提示
     - 優先順位付け
   - コストパフォーマンスの選択肢
     - 質と価格のバランス
     - 季節による変動
     - グループ割引
   - 予算超過時の調整案
     - 宿泊グレードの変更
     - 交通手段の見直し
     - アクティビティの優先順位付け

3. 総評
   - 予算の実現可能性評価
     - 項目別の評価
     - リスク分析
     - 実現確度
   - 季節による価格変動
     - ハイシーズン
     - オフシーズン
     - 特別期間

## 4. 技術仕様

### 4.1 クラス構成
- `TravelPlannerGraph`
  - コンストラクタ
    - 引数: ChatOpenAI インスタンス
    - 初期化処理: LLMの設定
  - メソッド
    - generatePlan
      - 引数: TravelPlanInput
      - 戻り値: Promise<string>
      - 処理内容: プラン生成と最適化

### 4.2 インターフェース
```typescript
interface TravelPlanInput {
  destination: string;  // 目的地
  origin: string;      // 出発地
  duration: number;    // 旅行日数
  budget?: number;     // オプションの予算（円）
}
```

### 4.3 プロンプトテンプレート
- `planningPrompt`
  - 目的: 基本プラン生成
  - 入力変数
    - origin: 出発地
    - destination: 目的地
    - duration: 旅行日数
  - 出力形式: マークダウン形式

- `budgetOptimizationPrompt`
  - 目的: 予算最適化
  - 入力変数
    - originalPlan: 基本プラン
    - budget: 予算
  - 出力形式: マークダウン形式

### 4.4 エラーハンドリング
- 入力値検証
- API通信エラー
- タイムアウト処理
- 不正なレスポンス処理

## 5. 実行環境
- Node.js: v18.0.0以上
- TypeScript: v4.5.0以上
- OpenAI API
  - モデル: GPT-4
  - トークン制限: 8000トークン
  - レートリミット考慮

## 6. デフォルト設定
```typescript
const DEFAULT_INPUT = {
  origin: '日本',          // デフォルトの出発地
  destination: 'タイ',     // デフォルトの目的地
  duration: 5,            // デフォルトの旅行日数
  budget: 200000          // デフォルトの予算（円）
};

const API_CONFIG = {
  temperature: 0.7,      // 生成時の温度パラメータ
  maxTokens: 8000,       // 最大トークン数
  timeout: 30000         // タイムアウト時間（ミリ秒）
};
```

## 7. 制限事項
1. API制限
   - レートリミット
   - トークン制限
   - コスト考慮

2. 入力制限
   - 文字数制限
   - 数値範囲
   - 対応言語

3. 出力制限
   - レスポンスサイズ
   - フォーマット制約
   - 文字エンコーディング 